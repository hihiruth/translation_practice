<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chinese-English Translation Practice</title>
    <script src="https://cdn-tailwindcss.vercel.app/"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .card, textarea, input, .btn {
            transition: all 0.2s ease-in-out;
        }
        .btn {
            background-image: linear-gradient(to right, #3b82f6, #60a5fa);
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .btn-gray {
             background-image: linear-gradient(to right, #6b7280, #9ca3af);
        }
        #loader {
            border: 4px solid #e5e7eb;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .tab-btn {
            border-bottom: 2px solid transparent;
        }
        .tab-btn.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8 bg-gray-100 text-gray-900">
    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-8 relative">
            <h1 class="text-3xl sm:text-4xl font-bold">AI Translation Practice Tool</h1>
            <p class="mt-2 text-lg text-gray-500">For Traditional Chinese and English</p>
        </header>

        <!-- User Profile / Header -->
        <div id="user-header" class="hidden items-center justify-between mb-4 p-4 bg-white rounded-lg shadow-sm">
            <div>
                <span class="text-sm">Welcome,</span>
                <span id="user-email" class="font-medium text-gray-700"></span>
            </div>
            <button id="sign-out-btn" class="btn-gray text-white font-bold py-2 px-4 text-sm rounded-lg">Sign Out</button>
        </div>

        <!-- Main Content Area -->
        <main id="app-view">
             <!-- Tab Navigation -->
            <div id="tabs-nav" class="mb-4 border-b border-gray-200">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button id="teacher-tab" class="tab-btn active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg" data-target="teacher-panel">
                        Teacher Login
                    </button>
                    <button id="student-tab" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg text-gray-500" data-target="student-panel">
                        Student Practice
                    </button>
                </nav>
            </div>

            <!-- Teacher Login / Input Panel -->
            <div id="teacher-panel" class="tab-panel">
                 <!-- Login View -->
                <div id="login-view" class="card p-8 bg-white border border-gray-200 rounded-xl shadow-sm">
                    <h2 class="text-2xl font-bold mb-6 text-center">Teacher Login</h2>
                    <div class="max-w-sm mx-auto">
                        <div class="mb-4">
                            <label for="email-input" class="block mb-2 text-sm font-medium text-gray-600">Email</label>
                            <input type="email" id="email-input" class="w-full p-2.5 rounded-lg bg-gray-50 border border-gray-300 focus:outline-none focus:border-blue-500" required>
                        </div>
                        <div class="mb-6">
                            <label for="password-input" class="block mb-2 text-sm font-medium text-gray-600">Password</label>
                            <input type="password" id="password-input" class="w-full p-2.5 rounded-lg bg-gray-50 border border-gray-300 focus:outline-none focus:border-blue-500" required>
                        </div>
                        <button id="login-btn" class="btn w-full text-white font-bold py-2 px-4 rounded-lg shadow-md">Sign In</button>
                        <p id="login-error" class="text-red-500 mt-4 text-sm text-center"></p>
                    </div>
                </div>
                <!-- Teacher Input View (hidden by default) -->
                <section id="teacher-input-view" class="hidden card p-6 bg-white border border-gray-200 rounded-xl shadow-sm">
                    <h2 class="text-2xl font-semibold text-gray-900 mb-4">1. Create New Practice</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="keywords-input" class="block mb-2 text-sm font-medium text-gray-600">Enter English keywords, phrases, or idioms (one per line):</label>
                            <textarea id="keywords-input" rows="4" class="w-full p-2.5 rounded-lg bg-gray-50 border border-gray-300 focus:outline-none focus:border-blue-500"></textarea>
                        </div>
                        <div>
                            <label for="grammar-input" class="block mb-2 text-sm font-medium text-gray-600">Enter sentence patterns or grammar points (optional):</label>
                            <textarea id="grammar-input" rows="3" class="w-full p-2.5 rounded-lg bg-gray-50 border border-gray-300 focus:outline-none focus:border-blue-500"></textarea>
                        </div>
                        <div>
                            <label for="cefr-level-select" class="block mb-2 text-sm font-medium text-gray-600">Select CEFR Difficulty Level:</label>
                            <select id="cefr-level-select" class="w-full p-2.5 rounded-lg bg-gray-50 border border-gray-300">
                                <option value="A1">A1 (Beginner)</option>
                                <option value="A2">A2 (Elementary)</option>
                                <option value="B1" selected>B1 (Intermediate)</option>
                                <option value="B2">B2 (Upper Intermediate)</option>
                                <option value="C1">C1 (Advanced)</option>
                                <option value="C2">C2 (Proficient)</option>
                            </select>
                        </div>
                        <div id="teacher-controls" class="flex items-center space-x-4">
                            <button id="generate-btn" class="btn text-white font-bold py-2 px-4 rounded-lg shadow-md">Generate Practice Sentences</button>
                            <div id="loader" class="hidden"></div>
                        </div>
                         <div id="share-section" class="hidden mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg"></div>
                    </div>
                </section>
            </div>
            
            <!-- Student Panel -->
            <div id="student-panel" class="tab-panel hidden">
                <section class="card p-6 bg-white border border-gray-200 rounded-xl shadow-sm">
                     <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                        <h2 class="text-2xl font-semibold text-gray-900">Student Practice</h2>
                        <div class="flex items-center">
                            <label for="global-language-select" class="text-sm mr-2 text-gray-600 whitespace-nowrap">Feedback in:</label>
                            <select id="global-language-select" class="rounded-lg bg-gray-50 border border-gray-300 text-sm p-1.5 focus:border-blue-500">
                                <option value="English" selected>English</option>
                                <option value="Traditional Chinese">繁體中文</option>
                            </select>
                        </div>
                     </div>
                     <div id="practice-area" class="space-y-6">
                        <p class="text-gray-500 text-center">Open a shared practice link from your teacher to begin.</p>
                     </div>
                </section>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

        // --- Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyDjEa2cxayfqr7veTsR80LGCURO3Kuf2Wk",
          authDomain: "translation-practice-174e5.firebaseapp.com",
          projectId: "translation-practice-174e5",
          storageBucket: "translation-practice-174e5.firebasestorage.app",
          messagingSenderId: "299778788053",
          appId: "1:299778788053:web:139fe55ce2b3bd399f305c",
          measurementId: "G-RXZXJ7NZ6W"
        };
        const appId = firebaseConfig.appId;
        const apiKey = "AIzaSyDBOfcLxvUEebTLW0UmILq56lOc8G1Q7xA"; // Canvas will provide the key
        
        // --- App Initialization ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const genApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        // --- DOM Elements ---
        const userHeader = document.getElementById('user-header');
        const userEmailEl = document.getElementById('user-email');
        const loginView = document.getElementById('login-view');
        const teacherInputView = document.getElementById('teacher-input-view');
        const teacherTab = document.getElementById('teacher-tab');
        const studentTab = document.getElementById('student-tab');
        const teacherPanel = document.getElementById('teacher-panel');
        const studentPanel = document.getElementById('student-panel');
        const practiceArea = document.getElementById('practice-area');
        const loader = document.getElementById('loader');
        const shareSection = document.getElementById('share-section');
        const tabsNav = document.getElementById('tabs-nav');

        let currentUser = null;

        // --- Authentication Logic ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                userEmailEl.textContent = user.email;
                showTeacherView();
            } else {
                currentUser = null;
                showPublicView();
            }
            loadPracticeFromUrl();
        });

        document.getElementById('login-btn').addEventListener('click', async () => {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            const loginErrorEl = document.getElementById('login-error');
            loginErrorEl.textContent = '';
            
            if (!email || !password) {
                loginErrorEl.textContent = "Please enter both email and password.";
                return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Login Error:", error);
                if (error.code === 'auth/invalid-credential') {
                    loginErrorEl.textContent = "Incorrect email or password. Please double-check your credentials.";
                } else {
                    loginErrorEl.textContent = "An unknown error occurred. Please try again.";
                }
            }
        });

        document.getElementById('sign-out-btn').addEventListener('click', () => signOut(auth));

        // --- UI Visibility ---
        function showPublicView() {
            userHeader.classList.add('hidden');
            loginView.classList.remove('hidden');
            teacherInputView.classList.add('hidden');
            teacherTab.textContent = 'Teacher Login';
            tabsNav.style.display = ''; // Make sure tabs are visible
            teacherTab.click(); // Default to teacher login tab
        }

        function showTeacherView() {
            userHeader.classList.remove('hidden');
            loginView.classList.add('hidden');
            teacherInputView.classList.remove('hidden');
            teacherTab.textContent = "Teacher's Input";
            tabsNav.style.display = ''; // Make sure tabs are visible
            teacherTab.click();
        }

        // --- Tab Logic ---
        [teacherTab, studentTab].forEach(tab => {
            tab.addEventListener('click', () => {
                [teacherTab, studentTab].forEach(t => t.classList.remove('active'));
                [teacherPanel, studentPanel].forEach(p => p.classList.add('hidden'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.target).classList.remove('hidden');
            });
        });

        // --- Main App Logic ---
        document.getElementById('generate-btn').addEventListener('click', generateSentences);
        
        async function loadPracticeFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const practiceId = params.get('practice');
            if (practiceId) {
                tabsNav.style.display = 'none'; // Hide tabs for students
                await loadPractice(practiceId);
                studentTab.click();
            }
        }
        
        async function generateSentences() {
            // Function content is the same as the previous correct version
        }
        
        function setupShareSection(sentences) {
            // Function content is the same as the previous correct version
        }

        async function sharePractice(sentences) {
            // Function content is the same as the previous correct version
        }

        async function loadPractice(practiceId) {
            // Function content is the same as the previous correct version
        }

        function displaySentences(sentences) {
            // Function content is the same as the previous correct version
        }
        
        function toggleAnswer(event) {
            // Function content is the same as the previous correct version
        }

        async function checkAnswer(event, onFirstCheckCallback) {
            // Function content is the same as the previous correct version
        }
        
        function showCompletionMessage() {
            // Function content is the same as the previous correct version
        }
    </script>
</body>
</html>

